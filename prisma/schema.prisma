// 1. Configuración del Generador y Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------
// ENUMS (Listas de valores fijos)
// ------------------------------------------

enum PlanType {
  FREE
  BASIC
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PENDING
  EXPIRED
  CANCELLED
}

enum AppointmentStatus {
  PENDING     // Reservada
  CONFIRMED   // Aceptada por barbero (opcional)
  COMPLETED   // Servicio realizado
  CANCELLED   // Por cliente o barbero
  NO_SHOW     // Cliente no llegó
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD        // Preparado para futuro (Stripe, etc)
}

enum TransactionType {
  SERVICE     // Cobro de cita
  PRODUCT     // Venta de producto (cera, gel)
  TIP         // Propina
  OTHER       // Ajustes
  WITHDRAWAL // (Retiro/Gasto)
}

enum Role {
  BARBER
  ADMIN       // Para ti (Super Admin del sistema)
}

// ------------------------------------------
// MODELOS (Tablas)
// ------------------------------------------

/// Usuario principal del sistema (Barbero)
model Barber {
  id            String    @id @default(uuid())
  fullName      String    @map("nombre_completo")
  email         String    @unique
  passwordHash  String    @map("password_hash")
  phone         String    @map("telefono")
  avatarUrl     String?   @map("foto_perfil")
  rankingScore  Decimal   @default(0.00) @db.Decimal(3, 2) @map("ranking_score")
  role          Role      @default(BARBER)
  slug          String?   @unique @map("alias_url") //Alias para la URL
  isActive      Boolean   @default(true) @map("estado_cuenta")
  
  createdAt     DateTime  @default(now()) @map("fecha_registro")
  updatedAt     DateTime  @updatedAt

  // Relaciones
  subscription  Subscription?
  services      Service[]
  schedules     ScheduleConfig[]
  blocks        ScheduleBlock[]
  appointments  Appointment[]
  transactions  Transaction[]
  dailyCloses   DailyClose[]
  gallery       GalleryImage[]
  notifications Notification[]

  clients       Client[]

  @@map("barberos")
}

/// Cliente final
model Client {
  id            String    @id @default(uuid())

  // VINCULACIÓN AL TENANT (Barbero)
  barberId      String    @map("barbero_id")

  name          String    @map("nombre")
  phone         String    @map("telefono") // Identificador único
  email         String?   @map("email") // Opcional
  phoneHash     String?   @map("telefono_hash")    // Para validar reseñas
  internalNotes String?   @map("notas_internas")   // Notas del barbero

  createdAt     DateTime  @default(now()) @map("fecha_creacion")

  // Relaciones
  barber        Barber      @relation(fields: [barberId], references: [id])
  appointments  Appointment[]

  // CANDADO DE AISLAMIENTO 
  // Esto permite que el telefono se repita en la tabla, 
  // PERO NO para el mismo barbero.
  @@unique([phone, barberId], name: "client_phone_per_barber")

  @@index([phoneHash])
  @@map("clientes")
}

/// Subscripcin
model Subscription {
  id          Int       @id @default(autoincrement())
  barberId    String    @unique @map("barbero_id") // 1 a 1 actual
  type        PlanType  @map("tipo_plan")
  startDate   DateTime  @map("fecha_inicio")
  endDate     DateTime  @map("fecha_vencimiento")
  status      SubscriptionStatus @default(PENDING) @map("estado_pago")


  // --- CLIP ---
  clipPaymentId        String?   @unique @map("clip_payment_id")     // ID del pago en Clip
  clipCheckoutId       String?   @map("clip_checkout_id")            // ID del checkout creado
  clipPaymentMethod    String?   @map("clip_payment_method")         // card, transfer, etc
  lastPaymentDate      DateTime? @map("last_payment_date")           // Fecha del último pago exitoso
  nextPaymentDate      DateTime? @map("next_payment_date")           // Fecha del próximo cobro
  autoRenew            Boolean   @default(true) @map("auto_renew")   // Renovación automática

  barber      Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@map("suscripciones")
}

/// Catálogo de cortes y servicios
model Service {
  id          Int       @id @default(autoincrement())
  barberId    String    @map("barbero_id")
  name        String    @map("nombre")
  price       Decimal   @db.Decimal(10, 2) @map("precio")
  durationMin Int       @map("duracion_min") // En minutos
  isActive    Boolean   @default(true) @map("activo")

  barber      Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  galleryImages GalleryImage[]

  @@map("servicios")
}

/// Configuración semanal de horarios (Lunes, Martes...)
model ScheduleConfig {
  id          Int       @id @default(autoincrement())
  barberId    String    @map("barbero_id")
  dayOfWeek   Int       @map("dia_semana") // 0=Domingo, 1=Lunes... 6=Sábado
  startTime   DateTime  @db.Time @map("hora_apertura") // Solo guarda hora
  endTime     DateTime  @db.Time @map("hora_cierre")
  breakStart  DateTime? @db.Time @map("descanso_inicio")
  breakEnd    DateTime? @db.Time @map("descanso_fin")
  isWorkDay   Boolean   @default(true) @map("es_laborable")

  barber      Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@unique([barberId, dayOfWeek]) // Un solo config por día por barbero
  @@map("configuracion_horarios")
}

/// Bloqueos excepcionales (Vacaciones, Médico)
model ScheduleBlock {
  id          Int       @id @default(autoincrement())
  barberId    String    @map("barbero_id")
  startDate   DateTime  @map("fecha_inicio")
  endDate     DateTime  @map("fecha_fin")
  reason      String?   @map("motivo")

  barber      Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@map("bloqueos_agenda")
}

/// Citas
model Appointment {
  id            String    @id @default(uuid())
  barberId      String    @map("barbero_id")
  clientId      String    @map("cliente_id")
  serviceId     Int       @map("servicio_id")
  
  date          DateTime  @map("fecha_hora")
  frozenPrice   Decimal   @db.Decimal(10, 2) @map("precio_congelado")
  status        AppointmentStatus @default(PENDING) @map("estado")
  origin        String    @default("APP") // APP o POS
  notes         String?   @map("notas")

  createdAt     DateTime  @default(now())

  // Relaciones
  barber        Barber    @relation(fields: [barberId], references: [id])
  client        Client    @relation(fields: [clientId], references: [id])
  service       Service   @relation(fields: [serviceId], references: [id])
  
  transaction   Transaction? // Relación 1-1 opcional (se crea al pagar)
  review        Review?      // Relación 1-1 opcional (se crea al calificar)

  @@index([barberId, date]) // Búsqueda rápida de agenda
  @@map("citas")
}

/// Movimientos de dinero (POS)
model Transaction {
  id            Int       @id @default(autoincrement())
  barberId      String    @map("barbero_id")
  appointmentId String?   @unique @map("cita_id") // Opcional (puede ser venta libre)
  
  type          TransactionType @map("tipo")
  amount        Decimal   @db.Decimal(10, 2) @map("monto")
  method        PaymentMethod @map("metodo_pago")
  createdAt     DateTime  @default(now()) @map("fecha_creacion")
  
  dailyCloseId  Int?      @map("cierre_dia_id") // Vincula al cierre cuando este ocurre

  // Relaciones
  barber        Barber    @relation(fields: [barberId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  dailyClose    DailyClose?  @relation(fields: [dailyCloseId], references: [id])

  @@map("movimientos_financieros")
}

/// Cierre de caja diario (Inmutable)
model DailyClose {
  id            Int       @id @default(autoincrement())
  barberId      String    @map("barbero_id")
  date          DateTime  @map("fecha") @db.Date // Solo la fecha sin hora
  
  totalCash     Decimal   @db.Decimal(10, 2) @map("total_efectivo")
  totalTransfer Decimal   @db.Decimal(10, 2) @map("total_digital")
  totalDay      Decimal   @db.Decimal(10, 2) @map("total_dia")
  closedAt      DateTime  @default(now()) @map("hora_cierre")

  barber        Barber    @relation(fields: [barberId], references: [id])
  transactions  Transaction[]

  @@unique([barberId, date]) // Solo un cierre por día por barbero
  @@map("cierres_caja")
}

/// Reputación
model Review {
  id            Int       @id @default(autoincrement())
  appointmentId String    @unique @map("cita_id") // 1 a 1 estricto
  
  rating        Int       @map("puntuacion") // 1-5
  comment       String?   @map("comentario")
  isVisible     Boolean   @default(true) @map("visible")
  createdAt     DateTime  @default(now()) @map("fecha")

  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  @@map("calificaciones")
}

/// Galería de fotos
model GalleryImage {
  id            Int       @id @default(autoincrement())
  barberId      String    @map("barbero_id")
  serviceId     Int?      @map("servicio_id")
  
  imageUrl      String    @map("url_imagen")
  createdAt     DateTime  @default(now()) @map("fecha_subida")

  barber        Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)
  service       Service?  @relation(fields: [serviceId], references: [id])

  @@map("galeria")
}

/// Notificaciones del sistema
model Notification {
  id        Int      @id @default(autoincrement())
  barberId  String   @map("barbero_id")
  title     String   @map("titulo")
  message   String   @map("mensaje")
  isRead    Boolean  @default(false) @map("leida")
  createdAt DateTime @default(now()) @map("fecha_creacion")

  barber    Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}